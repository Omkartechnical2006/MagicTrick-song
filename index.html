<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Trick</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Performer View (Default) -->
    <div id="performerView" class="view">
        <div class="magic-container">
            <div class="magic-icon">ğŸ©âœ¨</div>
            <h1 class="magic-title">Waiting for magic...</h1>
            <div class="pulse-animation"></div>
            <p class="magic-subtitle">Think of your favorite song</p>
        </div>
    </div>

    <!-- Accomplice View (Hidden by default) -->
    <div id="accompliceView" class="view hidden">
        <div class="accomplice-container">
            <div class="accomplice-header">
                <h1>ğŸ¯ Control Panel</h1>
                <p class="secret-label">Secret Accomplice View</p>
            </div>

            <div class="input-section">
                <label for="youtubeLink">YouTube Link</label>
                <input type="url" id="youtubeLink" placeholder="https://youtube.com/watch?v=..." autocomplete="off" />

                <button id="sendButton" class="send-btn">
                    <span class="btn-text">Send Link</span>
                    <span class="btn-icon">ğŸš€</span>
                </button>

                <button id="clearButton" class="clear-btn">
                    <span class="btn-text">Clear Song</span>
                    <span class="btn-icon">ğŸ—‘ï¸</span>
                </button>

                <div id="statusMessage" class="status-message hidden"></div>
            </div>

            <div class="info-box">
                <p>âš ï¸ Keep this view hidden from the audience</p>
                <p>ğŸ’¡ Paste the YouTube link and click send when ready</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDutW8Gvc9NkXA1et9FxGZ22YeVAm0ZP6g",
            authDomain: "magictrick-c9765.firebaseapp.com",
            databaseURL: "https://magictrick-c9765-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "magictrick-c9765",
            storageBucket: "magictrick-c9765.firebasestorage.app",
            messagingSenderId: "52199363204",
            appId: "1:52199363204:web:2933234d10aa4334ea68d1",
            measurementId: "G-4HBX8W4D65"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const viewType = urlParams.get('view') || 'performer';

        // DOM elements
        const performerView = document.getElementById('performerView');
        const accompliceView = document.getElementById('accompliceView');
        const youtubeLink = document.getElementById('youtubeLink');
        const sendButton = document.getElementById('sendButton');
        const clearButton = document.getElementById('clearButton');
        const statusMessage = document.getElementById('statusMessage');

        // Show appropriate view
        if (viewType === 'accomplice') {
            performerView.classList.add('hidden');
            accompliceView.classList.remove('hidden');
            setupAccompliceView();
        } else {
            performerView.classList.remove('hidden');
            accompliceView.classList.add('hidden');
            setupPerformerView();
        }

        // Performer View Setup
        function setupPerformerView() {
            const linkRef = ref(database, 'currentLink');

            onValue(linkRef, (snapshot) => {
                const data = snapshot.val();
                if (data && data.url) {
                    // Small delay to make the magic feel more dramatic
                    setTimeout(() => {
                        window.location.href = data.url;
                    }, 500);
                }
            });
        }

        // Accomplice View Setup
        function setupAccompliceView() {
            sendButton.addEventListener('click', async () => {
                const url = youtubeLink.value.trim();

                if (!url) {
                    showStatus('Please enter a YouTube URL', 'error');
                    return;
                }

                if (!isValidYouTubeUrl(url)) {
                    showStatus('Please enter a valid YouTube URL', 'error');
                    return;
                }

                try {
                    sendButton.disabled = true;
                    sendButton.classList.add('loading');

                    const linkRef = ref(database, 'currentLink');
                    await set(linkRef, {
                        url: url,
                        timestamp: Date.now()
                    });

                    showStatus('âœ¨ Link sent successfully!', 'success');
                    youtubeLink.value = '';

                    setTimeout(() => {
                        sendButton.disabled = false;
                        sendButton.classList.remove('loading');
                    }, 1000);

                } catch (error) {
                    showStatus('Error sending link: ' + error.message, 'error');
                    sendButton.disabled = false;
                    sendButton.classList.remove('loading');
                }
            });

            // Allow Enter key to send
            youtubeLink.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendButton.click();
                }
            });

            // Clear button handler
            clearButton.addEventListener('click', async () => {
                try {
                    clearButton.disabled = true;
                    clearButton.classList.add('loading');

                    const linkRef = ref(database, 'currentLink');
                    await remove(linkRef);

                    showStatus('ğŸ—‘ï¸ Song cleared! Ready for next performance', 'success');

                    setTimeout(() => {
                        clearButton.disabled = false;
                        clearButton.classList.remove('loading');
                    }, 1000);

                } catch (error) {
                    showStatus('Error clearing song: ' + error.message, 'error');
                    clearButton.disabled = false;
                    clearButton.classList.remove('loading');
                }
            });
        }

        // Validate YouTube URL
        function isValidYouTubeUrl(url) {
            const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/.+/;
            return youtubeRegex.test(url);
        }

        // Show status message
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.classList.remove('hidden');

            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 3000);
        }
    </script>
</body>

</html>